" <!--\r\nThanks for opening a PR! Your contribution is much appreciated.\r\nTo make sure your PR is handled as smoothly as possible please:\r\n - Link issue via \"Closes #[issue_number]\r\n - Choose & follow the right checklist for the change that you're making:\r\n \r\nPlease make sure to add a changeset. Run `pnpm changeset` in the root directory to do so.\r\nThen select updated Blitz packages when prompted, and add a short message describing the changes. \r\nThe message should be user-facing â€” explain **what** was changed, not **how**.\r\nIgnore if there are no user-facing changes.   \r\n--> \r\n\r\nCloses: #3663 \r\n  \r\n## What are the changes and their implications? \r\n\r\n### Implement client-side plugin `middleware` and `events` \r\n\r\nReference: https://github.com/blitz-js/blitz/pull/3943#issuecomment-1314529266\r\n \r\n#### **Blitz Auth**\r\n\r\n- [x] provide ```beforeHttpRequest``` hook to set `csrf` header on request \r\n- [x] `beforeHttpResponse` hook to read session info on response and could emit the `blitz:session-created` event to reset the queries\r\n- [x] provide `onRpcError` hook that will run on every `rpc` call to check the type of error returned by the resolver\r\n\r\n#### **Blitz RPC**\r\n\r\n- [x] consume `beforeHttpRequest` and `beforeHttpResponse` hooks (to set/read headers)\r\n- [x] consume `onRpcError` response hook \r\n- [x] consume `onSessionCreated` to invalidate queries \r\n\r\n### Dependency changes\r\n\r\n- [x] move `@blitzjs/auth` dependency of `@blitzjs/rpc` from `dependencies` to `devDependencies`  \r\n\r\n### Tests Added:\r\n> Ported the https://github.com/blitz-js/legacy-framework/tree/main/test/integration/auth integration test from the old repo, as there is currently no `integration test` that tests both `blitz-rpc` and `blitz-auth` together.\r\n\r\n- [x] Integration Tests:\r\n  - [x] Add tests for `beforeHttpRequest` and `beforeHttpResponse` middleware hooks\r\n  - [x] Add tests for `onRpcError` and `onSessionCreated` event hooks\r\n- [x] Unit Tests in `blitz` package:\r\n  - [x] Add tests for `merge`, `pipe` and `reduceBlitzPlugins` functions\r\n- [x] Update `rpc`, `rpc-path-root` and `react-query-utils` integrations tests by removing `@blitzjs/auth` dependency\r\n\r\n### Misc Changes to CI\r\n- [x] remove `turborepo` caching action as it is not being used\r\n- [x] fix `playwright` installation for integration tests\r\n\r\n## Feature Checklist\r\n\r\n- [x] Changeset added (run `pnpm changeset` in the root directory)\r\n- [x] Documentation\r\n<details>\r\n<summary>\r\n\r\n## Example Client Plugin\r\n\r\n</summary>\r\n\r\n```tsx\r\n// src/custom-plugin/plugin.tsx\r\nimport { createClientPlugin } from \"blitz\"\r\nimport { ComponentProps, ComponentType } from \"react\"\r\n\r\ntype CustomPluginOptions = {\r\n  // ... \r\n}\r\n\r\nfunction withCustomPlugin<TProps = any>(Page: ComponentType<TProps> | BlitzPage<TProps>) {\r\n  const CustomPluginRoot = (props: ComponentProps<any>) => {    \r\n    // ... custom root component\r\n    return <Page {...props} />\r\n  }\r\n  for (let [key, value] of Object.entries(Page)) {\r\n    CustomPluginRoot[key] = value\r\n  }\r\n  if (process.env.NODE_ENV !== \"production\") {\r\n    CustomPluginRoot.displayName = `CustomPluginInnerRoot`\r\n  }\r\n  return CustomPluginRoot\r\n}\r\n\r\nexport const BlitzCustomPlugin = createClientPlugin<CustomPluginOptions, {}>(\r\n  (options?: CustomPluginOptions) => {\r\n    // ... plugin code\r\n    return {\r\n      events: {\r\n        onSessionCreated: async () => {\r\n          // Called when a new session is created - Usually when the user logs in or logs out\r\n        },\r\n        onRpcError: async () => {\r\n          // Called when an RPC call fails\r\n        },\r\n      },\r\n      middleware: {\r\n        beforeHttpRequest: (req) => {\r\n          //make changes to the request options before RPC call\r\n          return req\r\n        },\r\n        beforeHttpResponse: (res) => {\r\n          //make changes to the response before returning to the caller\r\n          return res\r\n        },\r\n      },\r\n      exports: () => ({\r\n        // ... plugin exports\r\n      }),\r\n      withProvider: withCustomPlugin,\r\n    }\r\n  }\r\n)\r\n\r\n```\r\n```ts\r\n// src/blitz-client.ts\r\nimport {AuthClientPlugin} from \"@blitzjs/auth\"\r\nimport {setupBlitzClient} from \"@blitzjs/next\"\r\nimport {BlitzRpcPlugin} from \"@blitzjs/rpc\"\r\nimport {BlitzCustomPlugin} from \"./custom-plugin/plugin\"\r\n\r\nexport const {withBlitz} = setupBlitzClient({\r\n  plugins: [\r\n    AuthClientPlugin({\r\n      cookiePrefix: \"web-cookie-prefix\",\r\n    }),\r\n    BlitzRpcPlugin({}),\r\n    BlitzCustomPlugin({}),\r\n  ],\r\n})\r\n```\r\n</details>\r\n"